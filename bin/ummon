#!/usr/bin/env node

var fork = require('child_process').fork;
var path = require('path');
var colors = require('colors');
var cli = require('optimist')
      .demand(0, 'Please provide at least one action')
      .describe('url', 'The url where the ummon server is running')
      .default('url', 'http://localhost:8888');

cli.usage('A CLI to interact with a ummon-server\nUsage: $0\n\
\n\
  ps: Show current worker counts and their pids');

var argv = cli.argv;

var ummon = require('../lib/client')(argv.url);

// Go to ummon root
process.chdir(path.resolve(__dirname, '..'));

var action = argv._.shift();

function done(){ process.exit(); } // Not sure why client is keeping process running


switch(action) {
    // Start the server
    case 'server':
      var server = fork('./server.js');
      console.log('Ummon server started. pid=%s'.rainbow, server.pid);
      break;


    // See whats running
    case 'ps':
      ummon.ps(function(result){
        console.log("Total workers:" + " %s".white, result.count);
        
        if (result.workers.length) {
          console.log("Worker PIDs:");
          for (var i = 0; i < result.workers.length; i++) {
            console.log(" - %s".white, result.workers[i]);
          }
        }
        done();
      });
      break;

    default:
      cli.showHelp();
}