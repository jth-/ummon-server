#!/usr/bin/env node
var optimist = require('optimist');
var spawn = require('child_process').spawn;
var path = require('path');
var fs = require('fs');
var mkdirp = require('mkdirp');


// Expose metadata for helmsman
exports.command = {
    description: 'Start up the ummon server'
};


if (require.main === module) {
  console.log(''); // Some padding for niceness

  var argv = optimist.usage(exports.command.description, {
    'config': {
      description: 'The path to your ummon config.json file',
      string: true,
      short: 'c',
    },
    'daemon': {
      description: 'Detach the server from the foreground and run in the background',
      boolean: true,
      short: 'd'
    }
  }).argv;

  if (argv.help) {
    return console.log(optimist.help());
  }

  var cwd = path.resolve(__dirname, '..')
  var spawnArgs = ['server.js'];

  if (argv.config) {
    spawnArgs.push(argv.config);
  }

  // Load the config
  var uu = require(path.resolve(__dirname, '../lib/utils.js'))
  var config = uu.loadConfig(argv);
  var pidPath = uu.pidPath(config);

  // fs.readFileSync(pidPath, {encoding:'utf8'});
  
  if (fs.existsSync(pidPath)) {
    console.log('ummon-server appears to be running. Pid file exists: %s', pidPath);
    process.exit();
  }

  var server;
  if (argv.daemon) {
    // If daemon is passed, create a detached process
    server = spawn('node', spawnArgs, {
      cwd: cwd,
      detached: true,
      stdio: 'ignore'
    });

    server.unref();
    
  } else {
    // Start the ummon-server
    server = spawn('node', spawnArgs, { 
      cwd: cwd,
      stdio: 'inherit'
    });
  }

  // Save the PID!
  if (!fs.existsSync(config.pids.path)) {
    mkdirp.sync(config.pids.path);
  }
  
  fs.writeFileSync(pidPath, server.pid);
  console.log('Server successfully started. pid: %s', process.pid);


  // If ctrl-c is pressed, clean up after yo'self
  process.on('SIGINT', function() {
    process.kill(server.pid, 'SIGINT');
    console.log('%s sent to ummon-server', SIG);
    fs.unlinkSync(pidPath);
  });
}